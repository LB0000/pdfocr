# レイアウト解析モジュール 詳細設計書

## 1. 概要

レイアウト解析モジュールは、PDF2MD拡張システムの中核機能として、OCR処理後のテキストと位置情報を利用して帳票の種類を自動判別し、各フィールドの位置を特定するコンポーネントです。ユーザーからのフィードバックを踏まえ、管理画面（補正UX）の充実とフィールド定義/バリデーションを優先的に設計・実装します。

## 2. 機能要件

### 2.1 帳票テンプレート管理機能

#### 2.1.1 テンプレート登録・編集
- テンプレート基本情報（名称、説明、カテゴリ等）の管理
- 類似書類のグループ化機能（バリエーション管理）
- テンプレートのバージョン管理
- テンプレートのアクティブ/非アクティブ状態管理

#### 2.1.2 フィールド定義
- フィールド基本情報（名称、説明、必須/任意等）の管理
- フィールド位置情報（座標、サイズ）の設定
- フィールドタイプ（テキスト、数値、日付、郵便番号、電話番号等）の設定
- バリデーションルール（正規表現、最大/最小値、文字数制限等）の設定
- 辞書参照設定（人名辞書、地名辞書、専門用語辞書等）

#### 2.1.3 テンプレート管理UI
- テンプレート一覧表示（検索・フィルタ機能付き）
- テンプレート詳細表示（フィールド一覧、プレビュー等）
- ビジュアルエディタ（ドラッグ＆ドロップでフィールド位置・サイズ編集）
- テンプレートのインポート/エクスポート機能

### 2.2 自動レイアウト判定機能

#### 2.2.1 テンプレートマッチング
- 特徴点抽出によるテンプレート照合
- キーワードベースのドキュメント分類
- 類似度スコアリングと閾値設定
- マッチング結果の信頼度評価

#### 2.2.2 未知レイアウト処理
- 新規レイアウト検出時の通知機能
- 類似テンプレートの提案機能
- 半自動テンプレート生成（キーワード抽出、レイアウト解析）
- 管理者による承認・編集フロー

#### 2.2.3 レイアウト解析アルゴリズム
- 矩形領域検出（表や枠線の認識）
- テキストブロックのグルーピング
- 見出し・ラベルとデータの関連付け
- 複数ページにまたがるレイアウトの処理

### 2.3 フィールド属性設定・バリデーション機能

#### 2.3.1 フィールド属性タイプ
- テキスト（一般文字列）
- 数値（整数、小数、金額等）
- 日付（年月日、年月、月日等）
- 時刻（時分秒、時分等）
- 郵便番号（3桁-4桁、7桁等）
- 電話番号（市外局番-市内局番-番号等）
- メールアドレス
- URL
- 住所（都道府県、市区町村、番地等）
- 人名（姓名、フリガナ等）
- 選択肢（チェックボックス、ラジオボタン等）
- その他カスタム型（正規表現定義）

#### 2.3.2 バリデーションルール
- 必須チェック
- 文字数制限（最小/最大）
- 値の範囲チェック（最小値/最大値）
- 正規表現パターンマッチング
- 辞書照合（人名、地名、専門用語等）
- 相関チェック（他フィールドとの整合性）
- カスタムバリデーション（JavaScript関数等）

#### 2.3.3 バリデーションUI
- エラー表示（インライン、サマリー等）
- 警告表示（確認要求、候補提示等）
- バリデーション結果の一覧表示
- バリデーションルールのテスト機能

## 3. 技術設計

### 3.1 コンポーネント構成

```
┌─────────────────────────────────────────────────────────────────┐
│                  レイアウト解析モジュール                         │
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ テンプレート管理  │  │ レイアウト解析   │  │ フィールド処理   │  │
│  │ コンポーネント    │  │ コンポーネント   │  │ コンポーネント   │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 3.1.1 テンプレート管理コンポーネント
- テンプレートCRUD操作
- フィールド定義CRUD操作
- テンプレートバージョン管理
- テンプレートインポート/エクスポート

#### 3.1.2 レイアウト解析コンポーネント
- テンプレートマッチングエンジン
- 特徴点抽出処理
- キーワード解析処理
- 新規テンプレート生成処理

#### 3.1.3 フィールド処理コンポーネント
- フィールド値抽出処理
- バリデーション処理
- 辞書照合処理
- 相関チェック処理

### 3.2 データモデル

#### 3.2.1 テンプレートモデル
```typescript
interface Template {
  id: string;
  name: string;
  description?: string;
  category?: string;
  version: number;
  isActive: boolean;
  createdBy: string;
  createdAt: Date;
  updatedAt: Date;
  keywords?: string[];
  matchingThreshold?: number;
  fields: Field[];
  groupId?: string; // 類似書類のグループID
}
```

#### 3.2.2 フィールドモデル
```typescript
interface Field {
  id: string;
  templateId: string;
  name: string;
  description?: string;
  type: FieldType;
  isRequired: boolean;
  x: number; // 左上X座標（相対値 0-1）
  y: number; // 左上Y座標（相対値 0-1）
  width: number; // 幅（相対値 0-1）
  height: number; // 高さ（相対値 0-1）
  page: number; // ページ番号（1始まり）
  validationRules: ValidationRule[];
  dictionaryRef?: string; // 参照辞書ID
  createdAt: Date;
  updatedAt: Date;
}

enum FieldType {
  TEXT = 'text',
  NUMBER = 'number',
  DATE = 'date',
  TIME = 'time',
  POSTAL_CODE = 'postal_code',
  PHONE_NUMBER = 'phone_number',
  EMAIL = 'email',
  URL = 'url',
  ADDRESS = 'address',
  PERSON_NAME = 'person_name',
  SELECTION = 'selection',
  CUSTOM = 'custom'
}
```

#### 3.2.3 バリデーションルールモデル
```typescript
interface ValidationRule {
  id: string;
  fieldId: string;
  type: ValidationRuleType;
  params: Record<string, any>; // ルール固有のパラメータ
  errorMessage?: string;
  priority: number; // 実行優先度
  isActive: boolean;
}

enum ValidationRuleType {
  REQUIRED = 'required',
  MIN_LENGTH = 'min_length',
  MAX_LENGTH = 'max_length',
  MIN_VALUE = 'min_value',
  MAX_VALUE = 'max_value',
  PATTERN = 'pattern',
  DICTIONARY = 'dictionary',
  CORRELATION = 'correlation',
  CUSTOM = 'custom'
}
```

#### 3.2.4 フィールド値モデル
```typescript
interface FieldValue {
  id: string;
  documentId: string;
  fieldId: string;
  value: string;
  originalValue?: string; // OCR結果の元の値
  confidence: number; // OCR信頼度
  isValidated: boolean; // バリデーション済みフラグ
  validationErrors?: ValidationError[];
  correctionId?: string; // 修正履歴ID
  createdAt: Date;
  updatedAt: Date;
}

interface ValidationError {
  ruleId: string;
  message: string;
  severity: 'error' | 'warning' | 'info';
}
```

### 3.3 アルゴリズム設計

#### 3.3.1 テンプレートマッチングアルゴリズム

1. **前処理**
   - OCR結果からテキストブロックと位置情報を抽出
   - ノイズ除去、正規化処理

2. **特徴点抽出**
   - キーワード出現頻度分析
   - レイアウト特徴量（表の位置、見出し位置等）の抽出
   - 固有表現（日付、金額等）の抽出

3. **テンプレート照合**
   - 各テンプレートとの類似度計算
   - 重み付きスコアリング（キーワード一致度、レイアウト一致度等）
   - 閾値判定による最適テンプレート選択

4. **結果処理**
   - マッチング結果の信頼度評価
   - 低信頼度の場合の代替テンプレート提案
   - マッチング失敗時の新規テンプレート候補生成

#### 3.3.2 フィールド値抽出アルゴリズム

1. **フィールド領域特定**
   - テンプレートのフィールド位置情報を元に、OCR結果から対応するテキストブロックを特定
   - 位置ずれ補正（アフィン変換等）

2. **テキスト抽出**
   - 特定された領域内のテキストを抽出
   - 複数テキストブロックの場合の結合処理

3. **型変換処理**
   - フィールドタイプに応じた変換処理（文字列→日付、数値等）
   - フォーマット正規化（日付形式統一、数値桁区切り除去等）

4. **バリデーション処理**
   - 定義されたバリデーションルールの適用
   - エラー・警告の収集

#### 3.3.3 新規テンプレート生成アルゴリズム

1. **レイアウト解析**
   - 表や枠線の検出
   - テキストブロックのグルーピング
   - 見出し・ラベルとデータの関連付け

2. **フィールド候補抽出**
   - ラベルテキストからフィールド名推定
   - データ型推定（数値、日付等の判別）
   - 必須項目推定（出現頻度等から判断）

3. **テンプレート構造化**
   - フィールド候補の構造化
   - 類似テンプレートからの情報補完
   - テンプレート基本情報の生成

### 3.4 API設計

#### 3.4.1 テンプレート管理API

```
GET    /api/templates                - テンプレート一覧取得
POST   /api/templates                - テンプレート作成
GET    /api/templates/:id            - テンプレート詳細取得
PUT    /api/templates/:id            - テンプレート更新
DELETE /api/templates/:id            - テンプレート削除
POST   /api/templates/:id/activate   - テンプレートアクティブ化
POST   /api/templates/:id/deactivate - テンプレート非アクティブ化
POST   /api/templates/:id/duplicate  - テンプレート複製
GET    /api/templates/:id/export     - テンプレートエクスポート
POST   /api/templates/import         - テンプレートインポート
GET    /api/templates/groups         - テンプレートグループ一覧取得
```

#### 3.4.2 フィールド管理API

```
GET    /api/templates/:id/fields           - フィールド一覧取得
POST   /api/templates/:id/fields           - フィールド作成
GET    /api/templates/:id/fields/:fieldId  - フィールド詳細取得
PUT    /api/templates/:id/fields/:fieldId  - フィールド更新
DELETE /api/templates/:id/fields/:fieldId  - フィールド削除
POST   /api/templates/:id/fields/reorder   - フィールド順序変更
```

#### 3.4.3 レイアウト解析API

```
POST   /api/layout/analyze              - レイアウト解析実行
POST   /api/layout/match                - テンプレートマッチング実行
GET    /api/layout/match/:jobId/status  - マッチング処理状態確認
GET    /api/layout/match/:jobId/result  - マッチング結果取得
POST   /api/layout/generate-template    - 新規テンプレート生成
```

#### 3.4.4 フィールド値API

```
GET    /api/documents/:id/field-values           - フィールド値一覧取得
PUT    /api/documents/:id/field-values/:fieldId  - フィールド値更新
POST   /api/documents/:id/validate               - ドキュメント全体バリデーション
GET    /api/documents/:id/validation-errors      - バリデーションエラー一覧取得
```

## 4. UI設計

### 4.1 テンプレート管理画面

#### 4.1.1 テンプレート一覧画面
- テンプレート検索・フィルタ機能
- テンプレート基本情報表示（名称、説明、作成日等）
- テンプレートアクション（編集、削除、複製等）
- テンプレートインポート/エクスポート機能

#### 4.1.2 テンプレート編集画面
- テンプレート基本情報編集
- フィールド一覧表示・編集
- ビジュアルエディタ（PDF表示＋フィールド位置編集）
- テンプレートプレビュー機能

#### 4.1.3 フィールド編集画面
- フィールド基本情報編集
- フィールドタイプ設定
- バリデーションルール設定
- 辞書参照設定

### 4.2 レイアウト解析結果画面

#### 4.2.1 マッチング結果表示
- マッチングテンプレート情報表示
- マッチング信頼度表示
- 代替テンプレート候補表示
- マッチング詳細情報表示（一致キーワード等）

#### 4.2.2 フィールド値表示
- フィールド値一覧表示
- バリデーションエラー表示
- 修正候補表示
- 一括修正機能

#### 4.2.3 新規テンプレート生成画面
- 自動生成フィールド一覧表示
- フィールド情報編集
- テンプレート基本情報設定
- 類似テンプレート参照機能

### 4.3 補正画面（優先実装）

#### 4.3.1 ドキュメントプレビュー
- PDF原本表示（ページ切替、ズーム機能付き）
- フィールド位置ハイライト表示
- 認識テキストオーバーレイ表示
- スクロール同期機能（原本と認識結果）

#### 4.3.2 認識結果編集
- インラインテキスト編集
- フィールド値一括編集
- バリデーションエラー表示・修正
- 修正履歴表示

#### 4.3.3 補正支援機能
- 修正候補表示（辞書参照、パターンマッチング等）
- ショートカットキー対応（Tab移動、Enter確定等）
- 一括置換機能
- 自動補完機能

## 5. 実装計画

### 5.1 フェーズ1: 基盤構築（2週間）
- データベーススキーマ実装
- テンプレート管理基本API実装
- フィールド管理基本API実装
- テンプレート管理UI基本実装

### 5.2 フェーズ2: 補正画面実装（優先）（3週間）
- ドキュメントプレビュー実装
- 認識結果編集機能実装
- バリデーション表示機能実装
- 補正支援機能実装

### 5.3 フェーズ3: フィールド属性・バリデーション実装（2週間）
- フィールドタイプ実装
- バリデーションルール実装
- 辞書参照機能実装
- バリデーションUI実装

### 5.4 フェーズ4: レイアウト解析エンジン実装（3週間）
- テンプレートマッチングアルゴリズム実装
- フィールド値抽出アルゴリズム実装
- 新規テンプレート生成アルゴリズム実装
- レイアウト解析API実装

### 5.5 フェーズ5: 統合・最適化（2週間）
- パフォーマンス最適化
- エラーハンドリング強化
- ユーザビリティ改善
- ドキュメント整備

## 6. 技術的課題と対策

### 6.1 テンプレートマッチング精度
- **課題**: 類似レイアウトの帳票を正確に区別することが難しい
- **対策**: 
  - 複数の特徴量（キーワード、レイアウト、固有表現等）を組み合わせたスコアリング
  - 機械学習モデル（SVM、Random Forest等）の活用
  - ユーザーフィードバックによる継続的な精度向上

### 6.2 フィールド位置のずれ
- **課題**: スキャン時の傾きや拡大縮小により、テンプレート定義位置とOCR結果位置がずれる
- **対策**:
  - アフィン変換による位置補正
  - 相対座標系の採用
  - マージン設定による許容範囲の拡大
  - アンカーポイント（基準点）を用いた位置調整

### 6.3 パフォーマンス
- **課題**: 大量の帳票処理時にレイアウト解析がボトルネックになる可能性
- **対策**:
  - 処理の並列化
  - キャッシュ機構の導入
  - 段階的処理（粗い判定→詳細判定）
  - バッチ処理とリアルタイム処理の分離

### 6.4 新規レイアウト対応
- **課題**: 未知のレイアウトに対する柔軟な対応
- **対策**:
  - 半自動テンプレート生成機能
  - 類似テンプレートからの情報補完
  - ユーザーによる簡易テンプレート定義UI
  - 継続的な学習によるテンプレート改善

## 7. まとめ

本設計書では、PDF2MD拡張システムのレイアウト解析モジュールについて、機能要件、技術設計、UI設計、実装計画、技術的課題と対策を詳細に定義しました。

ユーザーからのフィードバックを踏まえ、以下の優先順位で実装を進めます：

1. **補正画面（管理UX）の充実**: ユーザーが直感的に使える補正インターフェースを最優先で実装
2. **フィールド属性・バリデーション**: 精度向上に直結する機能として早期に実装
3. **テンプレート管理機能**: 類似書類のグループ化と個別テンプレート両方に対応
4. **レイアウト解析エンジン**: 自動判別と新規テンプレート生成機能

アジャイル開発アプローチを採用し、各フェーズで機能を実装・検証・改善していくことで、開発リスクを低減しながら価値を早期に提供します。
